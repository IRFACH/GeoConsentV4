<!DOCTYPE html>
<html>
<head>
  <title>GeoConsent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body style="font-family:sans-serif;text-align:center;padding:40px">

<h2 id="title">Verification</h2>
<p id="desc"></p>

<button id="gpsBtn" onclick="startGPS()" style="display:none;padding:12px 20px">
üìç Share Live Location
</button>

<br><br>

<button id="camBtn" onclick="capturePhoto()" style="display:none;padding:12px 20px">
üì∑ Capture Front Camera
</button>

<p id="status"></p>

<video id="video" autoplay playsinline style="display:none;width:100%"></video>
<canvas id="canvas" style="display:none"></canvas>

<script>
const params = new URLSearchParams(window.location.search);
const mode = params.get("mode");

const gpsBtn = document.getElementById("gpsBtn");
const camBtn = document.getElementById("camBtn");

if (mode === "gps") {
  document.getElementById("title").innerText = "üìç Location Verification";
  document.getElementById("desc").innerText =
    "You are requested to share your live location.";
  gpsBtn.style.display = "inline-block";
}

if (mode === "camera") {
  document.getElementById("title").innerText = "üì∑ Camera Verification";
  document.getElementById("desc").innerText =
    "You are requested to capture a front camera photo.";
  camBtn.style.display = "inline-block";
}

if (mode === "both") {
  document.getElementById("title").innerText = "üìç Location + Camera Verification";
  document.getElementById("desc").innerText =
    "You are requested to share location and capture a photo.";
  gpsBtn.style.display = "inline-block";
  camBtn.style.display = "inline-block";
}
</script>

<!-- GPS LIVE TRACKING -->
<script>
let watchID = null;

function startGPS() {
  document.getElementById("status").innerText = "Starting live location...";

  watchID = navigator.geolocation.watchPosition(
    pos => {
      fetch("/location", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          lat: pos.coords.latitude,
          lon: pos.coords.longitude,
          accuracy: pos.coords.accuracy,
          speed: pos.coords.speed || 0
        })
      });
    },
    err => alert("Location permission denied"),
    { enableHighAccuracy:true }
  );
}
</script>

<!-- CAMERA CAPTURE -->
<script>
async function capturePhoto() {
  document.getElementById("status").innerText = "Requesting camera permission...";

  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode:"user" }
  });

  const video = document.getElementById("video");
  video.style.display = "block";
  video.srcObject = stream;

  setTimeout(() => {
    const canvas = document.getElementById("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    canvas.getContext("2d").drawImage(video,0,0);

    const img = canvas.toDataURL("image/jpeg");
    stream.getTracks().forEach(t => t.stop());
    video.style.display = "none";

    fetch("/capture", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ image: img })
    });

    document.getElementById("status").innerText =
      "‚úÖ Photo captured successfully";
  },2000);
}
</script>

</body>
</html>
